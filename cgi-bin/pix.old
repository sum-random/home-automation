#!/usr/local/bin/bash

exec 2>&1
CMDVARS="`echo $QUERY_STRING | tr \& "\n" | grep =`"
eval "$CMDVARS"
[ -z "$YEAR" ] && YEAR=2
MOD="nathan$YEAR"
CGI=nathan
SOURCEDIR="/usr/local/Image/$MOD"
COMMENTS="$SOURCEDIR/comments.txt"; touch $COMMENTS
BASEDIR="$SOURCEDIR"
BASEWEB="/img/$MOD"
THUMBDIR="$SOURCEDIR/thumbsize"
THUMBWEB="$BASEWEB/thumbsize"
WEBSZDIR="$BASEDIR/websize"
WEBSZWEB="$BASEWEB/websize"
FULLSWEB="/img/$MOD"
FILELIST="`ls $SOURCEDIR | grep -i jpg `"
VPASS="YEAR=$YEAR"
THSZ=48
WBSZ=640

# Function declarations
makeThumbs() { 
      IMGSZ=`nice /usr/local/bin/identify $SOURCEDIR/$FNAME | awk '{print $3}'`
      IMGW=`echo $IMGSZ | cut -f 1 -d x | awk '{print $1}'`
      IMGH=`echo $IMGSZ | cut -f 2 -d x | awk '{print $1}'`
      if [ $IMGW -ge $IMGH ] ; then
        SCALE=`expr $IMGW / $THSZ` 
        TW=$THSZ
        TH=`expr $IMGH / $SCALE`
        SCALE=`expr $IMGW / $WBSZ` 
        WW=$WBSZ
        WH=`expr $IMGH / $SCALE`
      else
        SCALE=`expr $IMGH / $THSZ` 
        TW=`expr $IMGW / $SCALE`
        TH=$THSZ
        SCALE=`expr $IMGH / $WBSZ` 
        WW=`expr $IMGW / $SCALE`
        WH=$WBSZ
      fi
      [ -d $THUMBDIR ] || mkdir -p $THUMBDIR
      [ -d $WEBSZDIR ] || mkdir -p $WEBSZDIR
      nice /usr/local/bin/convert -sample ${TW}x${TH} $SOURCEDIR/$FNAME $THUMBDIR/$FNAME &
      nice /usr/local/bin/convert -sample ${WW}x${WH} $SOURCEDIR/$FNAME $WEBSZDIR/$FNAME &
      wait
}
showThumbs() {
  echo "Year: " ; for YR in 0 1 2 ; do [ "$YEAR" = "$YR" ] || echo "<A HREF=/$CGI?YEAR=$YR>$YR</A>  " ; done
#  [ "$COLUMNS" = "" ] && COLUMNS=8
  echo "<DIV>"
  COUNT=0
  for FNAME in `echo $FILELIST | tr " " "\n" | sort -r` ; do
    [ -f $THUMBDIR/$FNAME ] || makeThumbs
    echo "<A HREF='/$CGI?OPTION=SHOW&DISPFILE=$FNAME&$VPASS'>"
    ALT="BORDER=\"0\""
    grep -q ^$FNAME $COMMENTS && ALT="ALT=\"`cat $COMMENTS | grep ^$FNAME | cut -f 2- -d : | sed -e 's/<BR>//g'`\" BORDER=\"1\""
    echo "<IMG SRC='$THUMBWEB/$FNAME' $ALT></A>"
  done
  echo "</DIV>"

}

showImage(){
  NC="LAST"
  for FNAME in $FILELIST ; do
    [ "$NF" = "" ] && NF="$FNAME"
    NL=$FNAME
    NA="$NB"
    NB="$NC"
    NC="$FNAME"
    [ "$F3" = "" ] && F3="$FNAME"
    if [ "$NC" = "$DISPFILE" ] ; then
      F1="$NB"
    elif [ "$NB" = "$DISPFILE" ] ; then
      F1="$NA"
      F3="$NC"
    fi
  done
  [ "$F1" = "LAST" ] && F1="$FNAME"
  [ -f $WEBSZDIR/$FNAME ] || makeThumbs
  [ -z "$COMMENT" ] || echo "$DISPFILE:$COMMENT<BR>" | tr + \ | sed -e 's/%3A/:/g' -e s/%27/\'/g -e 's/%22/\"/g' -e 's/%5E/^/g' -e 's/%26/&/g' -e 's/%28/(/g' -e 's/%29/)/g' -e 's/%2B/+/g' -e 's/%3D/=/g' -e 's/%7E/~/g' -e 's/%2F/\//g' -e 's/%3F/?/g' -e 's/%3C/</g' -e 's/%3E/>/g' -e 's/%5C/\\/g' -e 's/%7C/|/g' -e 's/%2C/,/g' -e 's/%21/!/g' -e 's/%40/@/g' -e 's/%23/#/g' -e 's/%24/$/g' -e 's/%25/%/g'  >>$COMMENTS
  echo "<CENTER>"
  echo "<TABLE BORDER='0'><TR>"
  echo "<TD ALIGN='CENTER' WIDTH='644' COLSPAN='7'><A HREF='$FULLSWEB/$DISPFILE' TITLE='Full resolution'><IMG SRC='$WEBSZWEB/$DISPFILE'></A>"
  cat $COMMENTS | grep ^$DISPFILE | cut -f 2- -d : 
  echo "</TD></TR><TR>"
  echo "<TD VALIGN='TOP' ALIGN='CENTER'><A HREF='/$CGI?OPTION=SHOW&DISPFILE=$NF&$VPASS' TITLE="First"><IMG SRC='$THUMBWEB/$NF'></A></TD>"
  echo "<TD VALIGN='TOP' ALIGN='CENTER'><A HREF='/$CGI?OPTION=SHOW&DISPFILE=$F1&$VPASS' TITLE="Previous"><IMG SRC='$THUMBWEB/$F1'></A></TD>"
  echo "<TD VALIGN='TOP' ALIGN='CENTER'><A HREF='/cgi-bin/IM.pl?IMG=$WEBSZWEB/$DISPFILE' TITLE='Collage'><IMG SRC='/img/collage.jpg'></A></TD>"
  echo "<TD VALIGN='TOP' ALIGN='CENTER'><A HREF='/$CGI?$VPASS' TITLE="Index"><IMG SRC='/img/btn_up.jpg'></A></TD>"
  echo -n "<TD VALIGN='TOP' ALIGN='CENTER'><A HREF='/$CGI?$VPASS&OPTION=SHOW&DISPFILE="
  [ "$AUTO" = "TRUE" ] && echo -n "$DISPFILE"
  [ "$AUTO" != "TRUE" ] && echo -n "$F3"
  echo -n "&AUTO="
  [ "$AUTO" = "TRUE" ] && echo -n "FALSE"
  [ "$AUTO" != "TRUE" ] && echo -n "TRUE"
  echo "' TITLE="Slideshow"><IMG SRC='/img/projector.GIF'></A></TD>"
  echo "<TD VALIGN='TOP' ALIGN='CENTER'><A HREF='/$CGI?OPTION=SHOW&DISPFILE=$F3&$VPASS' TITLE="Next"><IMG SRC='$THUMBWEB/$F3'></A></TD>"
  echo "<TD VALIGN='TOP' ALIGN='CENTER'><A HREF='/$CGI?OPTION=SHOW&DISPFILE=$NL&$VPASS' TITLE="Last"><IMG SRC='$THUMBWEB/$NL'></A></TD>"
  echo "</TR></TABLE>"
  echo "<FORM><INPUT TYPE='HIDDEN' NAME='OPTION' VALUE='SHOW'><INPUT TYPE='HIDDEN' NAME='DISPFILE' VALUE='$DISPFILE'><INPUT TYPE='HIDDEN' NAME='YEAR' VALUE='$YEAR'><INPUT TYPE='TEXT' NAME='COMMENT'><INPUT TYPE='SUBMIT' VALUE='Add comment'></FORM>"
  echo "</CENTER>"
}


# display page
echo "Content-type: text/html; charset=iso-8859-1"
echo
echo "<HTML><HEAD>"
if [ "$OPTION" = "SHOW" ] && [ "$AUTO" = "TRUE" ] ; then
  FF=""
  NXTPIC=""
  for FNAME in $FILELIST ; do
    [ "$NXTPIC" = "" ] && NXTPIC="$FNAME"
    if [ "$FNAME" = "$DISPFILE" ] ; then
      FF="$FNAME"
    elif [ "$FF" = "$DISPFILE" ] ; then
      NXTPIC="$FNAME"
      FF=""
    fi
  done
  echo "<META HTTP-EQUIV='REFRESH' CONTENT='10;URL=/$CGI?$VPASS&OPTION=SHOW&DISPFILE=$NXTPIC&AUTO=TRUE'/>"
fi
echo "<TITLE>Tucker Family Pictures</TITLE></HEAD>"
echo "<BODY>"
  if [ "$OPTION" = "SHOW" ] ; then
    showImage
  else
    showThumbs
  fi
echo "</BODY></HTML>"

